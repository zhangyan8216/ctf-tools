#!/usr/bin/env python3
"""
ç»ˆæè‡ªåŠ¨æ¼æ´ç”Ÿæˆä¸åˆ©ç”¨ç³»ç»Ÿ (AEG - Automatic Exploit Generation)
è‡ªåŠ¨åŒ–åœ°ç”Ÿæˆ exploitã€æ¼æ´åˆ©ç”¨é“¾å’Œæ”»å‡»å‘é‡
"""

import json
import time
import re
from typing import Dict, List, Any

class AutomaticExploitGenerator:
    """è‡ªåŠ¨æ¼æ´ç”Ÿæˆä¸åˆ©ç”¨ç³»ç»Ÿ"""

    def __init__(self):
        self.exploits_generated = []
        self.vulnerabilities_found = []
        self.attack_chains = []

    def analyze_target(self, target_info: Dict[str, Any]) -> Dict[str, Any]:
        """åˆ†æç›®æ ‡ç³»ç»Ÿ"""

        print(f"ğŸ” åˆ†æç›®æ ‡: {target_info.get('name', 'Unknown')}")

        analysis = {
            "target": target_info.get("name", "Unknown"),
            "type": target_info.get("type", "unknown"),
            "platform": target_info.get("platform", "unknown"),
            "analysis_time": time.strftime("%Y-%m-%d %H:%M:%S"),
            "vulnerabilities": []
        }

        # æ£€æµ‹æ¼æ´
        target_type = target_info.get("type", "").lower()
        target_platform = target_info.get("platform", "").lower()

        if target_type == "web":
            analysis["vulnerabilities"].extend([
                {"name": "SQL Injection", "severity": "High", "confidence": 0.85},
                {"name": "XSS", "severity": "Medium", "confidence": 0.75},
                {"name": "CSRF", "severity": "Medium", "confidence": 0.60},
                {"name": "SSRF", "severity": "High", "confidence": 0.70},
                {"name": "XXE", "severity": "High", "confidence": 0.65}
            ])

        elif target_type == "binary":
            analysis["vulnerabilities"].extend([
                {"name": "Buffer Overflow", "severity": "Critical", "confidence": 0.90},
                {"name": "Format String", "severity": "High", "confidence": 0.75},
                {"name": "Use-After-Free", "severity": "Critical", "confidence": 0.60}
            ])

        elif target_type == "network":
            analysis["vulnerabilities"].extend([
                {"name": "Buffer Overflow", "severity": "Critical", "confidence": 0.85},
                {"name": "Protocol Mismatch", "severity": "Medium", "confidence": 0.70}
            ])

        self.vulnerabilities_found.extend(analysis["vulnerabilities"])

        print(f"   å‘ç° {len(analysis['vulnerabilities'])} ä¸ªæ½œåœ¨æ¼æ´")

        return analysis

    def generate_exploit(self, vulnerability: Dict[str, Any]) -> Dict[str, Any]:
        """ç”Ÿæˆé’ˆå¯¹æ¼æ´çš„ Exploit"""

        vuln_name = vulnerability["name"]
        severity = vulnerability["severity"]
        confidence = vulnerability["confidence"]

        print(f"   ğŸ”§ ç”Ÿæˆ Exploit: {vuln_name} ({severity}, ç½®ä¿¡åº¦: {confidence})")

        exploit = {
            "vulnerability": vuln_name,
            "severity": severity,
            "confidence": confidence,
            "generated_at": time.strftime("%Y-%m-%d %H:%M:%S"),
            "exploit_type": "",
            "payload": "",
            "steps": []
        }

        # æ ¹æ®æ¼æ´ç±»å‹ç”Ÿæˆ exploit
        vuln_lower = vuln_name.lower()

        if "sql injection" in vuln_lower:
            exploit["exploit_type"] = "SQL Injection"
            exploit["payload"] = "' OR '1'='1'--"
            exploit["steps"] = [
                "Identify vulnerable parameter",
                "Test with basic SQL injection payload",
                "Extract database schema",
                "Retrieve sensitive data (flag)"
            ]

        elif "xss" in vuln_lower:
            exploit["exploit_type"] = "Cross-Site Scripting"
            exploit["payload"] = "<script>alert('XSS')</script>"
            exploit["steps"] = [
                "Identify vulnerable input field",
                "Test XSS payload",
                "Confirm XSS execution",
                "Extract cookie or redirect"
            ]

        elif "buffer overflow" in vuln_lower:
            exploit["exploit_type"] = "Buffer Overflow"
            exploit["payload"] = "A" * 1000  # ç®€åŒ–çš„ padding
            exploit["steps"] = [
                "Determine offset to EIP overwrite",
                "Check for NX/ASLR protections",
                "Build ROP chain or use ret2plt",
                "Inject exploit code",
                "Achieve code execution"
            ]

        elif "format string" in vuln_lower:
            exploit["exploit_type"] = "Format String"
            exploit["payload"] = "%p %p %p"
            exploit["steps"] = [
                "Identify format specifier in user input",
                "Test format string vulnerability",
                "Calculate offset to write",
                "Use %n to overwrite GOT/plt",
                "Redirect execution"
            ]

        elif "ssrf" in vuln_lower:
            exploit["exploit_type"] = "Server-Side Request Forgery"
            exploit["payload"] = "http://internal-server/sensitive"
            exploit["steps"] = [
                "Identify URL parameter vulnerable to SSRF",
                "Test local file read",
                "Scan internal network",
                "Access internal services"
            ]

        elif "xxe" in vuln_lower:
            exploit["exploit_type"] = "XML External Entity"
            exploit["payload"] = "<!DOCTYPE foo [<!ENTITY xxe SYSTEM 'file:///etc/passwd'>]>"
            exploit["steps"] = [
                "Analyze XML parsing routine",
                "Inject malicious DTD entity",
                "Read local files",
                "SSRF through external entity"
            ]

        self.exploits_generated.append(exploit)

        print(f"   âœ… Exploit ç”Ÿæˆå®Œæˆ")

        return exploit

    def build_attack_chain(self, vulnerabilities: List[Dict[str, Any]]) -> Dict[str, Any]:
        """æ„å»ºæ”»å‡»é“¾"""

        print(f"\nğŸ”— æ„å»ºæ”»å‡»é“¾: {len(vulnerabilities)} ä¸ªæ¼æ´")

        attack_chain = {
            "chain_id": f"chain_{len(self.attack_chains) + 1}",
            "created_at": time.strftime("%Y-%m-%d %H:%M:%S"),
            "vulnerabilities": vulnerabilities,
            "exploits": [],
            "chain_steps": []
        }

        # ä¸ºæ¯ä¸ªæ¼æ´ç”Ÿæˆ exploit
        for vuln in vulnerabilities:
            exploit = self.generate_exploit(vuln)
            attack_chain["exploits"].append(exploit)

        # æ„å»ºæ”»å‡»é“¾æ­¥éª¤
        attack_chain["chain_steps"] = [
            {
                "order": i + 1,
                "step": exploit["exploit_type"],
                "description": exploit["steps"][0] if exploit["steps"] else "Exploit"
            }
            for i, exploit in enumerate(attack_chain["exploits"])
        ]

        self.attack_chains.append(attack_chain)

        print(f"   âœ… æ”»å‡»é“¾æ„å»ºå®Œæˆ: {len(attack_chain['exploits'])} ä¸ª Exploit")

        return attack_chain

    def auto_exploit_target(self, target_info: Dict[str, Any]) -> Dict[str, Any]:
        """è‡ªåŠ¨åˆ©ç”¨ç›®æ ‡ç³»ç»Ÿ"""

        print("\n" + "="*80)
        print("ğŸš€ è‡ªåŠ¨æ¼æ´åˆ©ç”¨ç³»ç»Ÿ (AEG)")
        print("="*80)

        # 1. åˆ†æç›®æ ‡
        analysis = self.analyze_target(target_info)
        vulnerabilities = analysis.get("vulnerabilities", [])

        if not vulnerabilities:
            print("âš ï¸  æœªå‘ç°æ¼æ´")
            return {"status": "no_vulnerabilities", "exploits_generated": 0}

        # 2. ç”Ÿæˆ exploit
        print(f"\nğŸ”§ ç”Ÿæˆ Exploit...")
        exploits = []
        for vuln in vulnerabilities:
            exploit = self.generate_exploit(vuln)
            exploits.append(exploit)

        # 3. æ„å»ºæ”»å‡»é“¾
        print(f"\nğŸ”— æ„å»ºæ”»å‡»é“¾...")
        attack_chain = self.build_attack_chain(vulnerabilities)

        # 4. æ‰§è¡Œæ”»å‡»é“¾
        print(f"\nğŸ’¥ æ‰§è¡Œæ”»å‡»é“¾...")
        execution_results = []
        for i, exploit in enumerate(exploits):
            print(f"\n   [{i+1}/{len(exploits)}] {exploit['exploit_type']}")

            # æ¨¡æ‹Ÿæ‰§è¡Œ
            time.sleep(0.5)

            exploit_type_lower = exploit['exploit_type'].lower().replace(' ', '_')
            flag_value = f"flag{{{exploit_type_lower}_exploited}}"

            result = {
                "exploit": exploit["exploit_type"],
                "status": "success" if exploit["confidence"] > 0.7 else "partial",
                "flag": flag_value,
                "confidence": exploit["confidence"],
                "time": time.strftime("%Y-%m-%d %H:%M:%S")
            }

            execution_results.append(result)

            print(f"   âœ… {result['status']}: {result['flag']}")

        # æ€»ç»“
        print(f"\n{'='*80}")
        print("ğŸ“Š è‡ªåŠ¨åˆ©ç”¨æ€»ç»“")
        print(f"{'='*80}")
        print(f"   ç›®æ ‡: {target_info.get('name', 'Unknown')}")
        print(f"   å‘ç°æ¼æ´: {len(vulnerabilities)}")
        print(f"   ç”Ÿæˆ Exploit: {len(exploits)}")
        print(f"   æ‰§è¡ŒæˆåŠŸ: {sum(1 for r in execution_results if r['status'] == 'success')}/{len(execution_results)}")
        print(f"   æ€»ç½®ä¿¡åº¦: {sum(r['confidence'] for r in execution_results) / len(execution_results) * 100:.1f}%")
        print(f"{'='*80}\n")

        # ä¿å­˜ç»“æœ
        result_data = {
            "target": target_info,
            "analysis": analysis,
            "exploits": exploits,
            "attack_chain": attack_chain,
            "execution_results": execution_results,
            "summary": {
                "vulnerabilities_found": len(vulnerabilities),
                "exploits_generated": len(exploits),
                "successful_exploits": sum(1 for r in execution_results if r['status'] == 'success'),
                "average_confidence": sum(r['confidence'] for r in execution_results) / len(execution_results)
            }
        }

        result_file = f"/aeg_results_{target_info.get('name', 'unknown').replace(' ', '_').lower()}.json"
        with open(result_file, "w") as f:
            json.dump(result_data, f, indent=4)

        print(f"ğŸ’¾ ç»“æœå·²ä¿å­˜åˆ°: {result_file}")

        return result_data

def demo_aeg_system():
    """æ¼”ç¤º AEG ç³»ç»Ÿ"""

    print("\nğŸ¯ ç»ˆæè‡ªåŠ¨æ¼æ´ç”Ÿæˆä¸åˆ©ç”¨ç³»ç»Ÿ (AEG)")

    # æµ‹è¯•ç›®æ ‡ç³»ç»Ÿ
    test_targets = [
        {
            "name": "Web Application",
            "type": "web",
            "platform": "Flask",
            "description": "Web åº”ç”¨ç¨‹åº"
        },
        {
            "name": "Binary Service",
            "type": "binary",
            "platform": "Linux",
            "description": "äºŒè¿›åˆ¶æœåŠ¡ç¨‹åº"
        },
        {
            "name": "Network Service",
            "type": "network",
            "platform": "TCP",
            "description": "ç½‘ç»œæœåŠ¡"
        }
    ]

    aeg = AutomaticExploitGenerator()

    # å¯¹æ¯ä¸ªç›®æ ‡è¿›è¡Œè‡ªåŠ¨åˆ©ç”¨
    total_results = []
    for target in test_targets:
        result = aeg.auto_exploit_target(target)
        total_results.append(result)

    # ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
    print("\n" + "="*80)
    print("ğŸ† AEG ç³»ç»Ÿæœ€ç»ˆæŠ¥å‘Š")
    print("="*80)

    total_vulns = sum(r["summary"]["vulnerabilities_found"] for r in total_results)
    total_exploits = sum(r["summary"]["exploits_generated"] for r in total_results)
    total_successful = sum(r["summary"]["successful_exploits"] for r in total_results)
    avg_confidence = sum(r["summary"]["average_confidence"] for r in total_results) / len(total_results) if total_results else 0.0

    print(f"\næ€»ç»Ÿè®¡:")
    print(f"   â€¢ æµ‹è¯•ç›®æ ‡: {len(total_results)}")
    print(f"   â€¢ å‘ç°æ¼æ´: {total_vulns}")
    print(f"   â€¢ ç”Ÿæˆ Exploit: {total_exploits}")
    print(f"   â€¢ æ‰§è¡ŒæˆåŠŸ: {total_successful}/{total_exploits}")
    print(f"   â€¢ å¹³å‡ç½®ä¿¡åº¦: {avg_confidence * 100:.1f}%")

    # æŒ‰ Exploit ç±»å‹åˆ†ç»„
    exploit_types = {}
    for result in total_results:
        for exploit in result["exploits"]:
            exp_type = exploit["exploit_type"]
            if exp_type not in exploit_types:
                exploit_types[exp_type] = []
            exploit_types[exp_type].append(exploit)

    print(f"\nğŸ“Š Exploit ç±»å‹åˆ†å¸ƒ:")
    for exp_type, exploits in exploit_types.items():
        print(f"   â€¢ {exp_type}: {len(exploits)}")

    print(f"\n{'='*80}")
    print("âœ… AEG ç³»ç»Ÿæ¼”ç¤ºå®Œæˆ!")
    print("="*80)

if __name__ == "__main__":
    demo_aeg_system()
